#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <stdio.h>
#include <inttypes.h>
#include <string.h>
#include <htslib/bgzf.h>
#include <htslib/tbx.h>
#include <htslib/kstring.h>

#include "unity.h"
#include "bpt.h"
#include "giggle_index.h"
#include "file_read.h"
#include "lists.h"

void setUp(void) { }
void tearDown(void) { }

//{{{void test_init_file(void)
void test_init_file(void)
{
    struct input_file *i = input_file_init("../data/1k.sort.bed.gz");
    TEST_ASSERT_NOT_NULL(i);
    input_file_destroy(&i);
    TEST_ASSERT_NULL(i);

    i = input_file_init("../data/1k.vcf");
    TEST_ASSERT_NULL(i);

    i = input_file_init("../data/bad.bed.gz");
    TEST_ASSERT_NULL(i);
}
//}}}

//{{{void test_bed_file_read(void)
void test_bed_file_read(void)
{

    struct input_file *i = input_file_init("../data/1k.unsort.bed.gz");

    int chrm_len = 10;
    char *chrm = (char *)malloc(chrm_len*sizeof(char));
    uint32_t start, end;
    long offset;
    kstring_t line = { 0, 0, NULL };

    char *chrm_A[10] = {
        "11",
        "11",  
        "10",  
        "16",  
        "15",  
        "19",  
        "19",  
        "18",  
        "21",  
        "7"};

    uint32_t start_A[10] = {64691252,
        129871988,
        74031859, 
        3070038,
        93346819,  
        4374094,
        42805980,
        3602738,
        9825304,
        2393484};


    uint32_t end_A[10] = {64692359,
        129873775,
        74037598,
        3072761,
        93347932,
        4376369,
        42807400,
        3605403,
        9827741,
        2394629};

    int j;
    for (j = 0; j < 10; ++j) {
        int ret = i->input_file_get_next_interval(i,
                                                  &chrm,
                                                  &chrm_len,
                                                  &start,
                                                  &end,
                                                  &offset,
                                                  &line);
        TEST_ASSERT_EQUAL(0,strcmp(chrm_A[j], chrm));
        TEST_ASSERT_EQUAL(start_A[j], start);
        TEST_ASSERT_EQUAL(end_A[j], end);
    }

    while (i->input_file_get_next_interval(i,
                                           &chrm,
                                           &chrm_len,
                                           &start,
                                           &end,
                                           &offset,
                                           &line) >= 0) {
        ++j;
    }

    if (line.s != NULL)
        free(line.s);

    TEST_ASSERT_EQUAL(0,strcmp("1", chrm));
    TEST_ASSERT_EQUAL(25895359, start);
    TEST_ASSERT_EQUAL(25896171, end);

    TEST_ASSERT_EQUAL(1000, j);

    input_file_destroy(&i);
}
//}}}

//{{{void test_get_file_stats(void)
void test_get_file_stats(void)
{

    struct input_file *i = input_file_init("../data/1k.unsort.bed.gz");
    struct unordered_list *file_index = unordered_list_init(1);


    struct file_data *fd = (struct file_data *)
        calloc(1, sizeof(struct file_data));

    uint32_t file_id = unordered_list_add(file_index, fd);

    fd->file_name = strdup("../data/1k.unsort.bed.gz");
    fd->num_intervals = 0;
    fd->mean_interval_size = 0;

    int chrm_len = 10;
    char *chrm = (char *)malloc(chrm_len*sizeof(char));
    uint32_t start, end;
    long offset;
    kstring_t line = { 0, 0, NULL };

    uint32_t j = 0;

    struct file_id_offset_pair *p;
    uint32_t intrv_id;

    while (i->input_file_get_next_interval(i,
                                           &chrm,
                                           &chrm_len,
                                           &start,
                                           &end,
                                           &offset,
                                           &line) >= 0) {
        fd->mean_interval_size += end-start;
        fd->num_intervals += 1;
    }

    fd->mean_interval_size = fd->mean_interval_size/fd->num_intervals;
    input_file_destroy(&i);
    free(chrm);

    if (line.s != NULL)
        free(line.s);

    char *out_file_name = "test_file_data_read_write.tmp";

    FILE *f = fopen(out_file_name, "wb");
    unordered_list_store(file_index, f, out_file_name, file_data_store);
    fclose(f);

    f = fopen(out_file_name, "rb");
    struct unordered_list *file_index_r = 
        unordered_list_load(f,
                            out_file_name,
                            file_data_load);

    struct file_data *fd_r = (struct file_data *)
            unordered_list_get(file_index_r, file_id);

    TEST_ASSERT_EQUAL(0, strcmp(fd->file_name, fd_r->file_name));
    TEST_ASSERT_EQUAL(fd->num_intervals, fd_r->num_intervals);
    TEST_ASSERT_EQUAL(fd->mean_interval_size, fd_r->mean_interval_size);

    unordered_list_destroy(&file_index, file_data_free);
    unordered_list_destroy(&file_index_r, file_data_free);

    remove(out_file_name);
}
//}}}

//{{{void test_get_file_stats(void)
void test_input_file_get_next_interval_vcf(void)
{
    struct input_file *i = input_file_init("../data/1k.vcf.gz");
    int chrm_len = 10;
    char *chrm = (char *)malloc(chrm_len*sizeof(char));
    uint32_t start, end;
    long offset;
    kstring_t line = { 0, 0, NULL };
    
    //{{{ chrms
    char *chrms[1000]={"1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","12","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","13","14","14","14","14","14","14","14","14","14","14","14","14","14","14","14","14","14","14","14","14","14","14","14","14","14","14","15","15","15","15","15","15","15","15","15","15","15","15","15","15","15","15","15","15","15","15","15","15","15","15","15","16","16","16","16","16","16","16","16","16","16","16","16","16","16","16","16","16","16","16","16","16","16","16","16","16","16","16","16","16","16","17","17","17","17","17","17","17","17","17","17","17","17","17","17","17","17","17","17","17","17","17","17","17","17","17","17","18","18","18","18","18","18","18","18","18","18","18","18","18","18","18","18","18","18","18","18","18","18","18","18","18","18","19","19","19","19","19","19","19","19","19","19","19","19","19","19","19","19","19","19","19","19","19","19","19","19","19","19","19","19","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","20","20","20","20","20","20","20","20","20","20","20","20","20","20","20","20","20","20","20","21","21","21","21","21","21","21","21","21","21","21","21","21","21","22","22","22","22","22","22","22","22","22","22","22","22","22","22","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","5","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","8","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X","X"};
   //}}} 
   //{{{ starts
    uint32_t starts[1000] = {1058898,9891824,11607635,14731108,17413149,22113048,28445925,31155603,31633156,34817842,47545813,50912662,53933585,59753427,63223646,64388047,64846773,70487141,72507513,75301685,77166921,80116488,81194341,93205828,94288372,99404771,101770067,103073101,104668206,110058198,111896187,115680818,120386838,153831851,159036297,162052665,163772800,170742233,172527329,173798014,174219098,176081402,177277056,186965858,188023767,188374208,189059819,190248809,193512331,194367496,198236233,215261384,216308287,218245628,229068064,231049189,231717173,234646607,238336076,242861579,246846330,247187956,247871833,354142,1631165,3218373,4825556,9297262,13056261,18831144,19791535,24604563,36649048,37731342,43041974,43250102,43720457,45663886,47531022,49459799,52271499,53869343,57890605,60450369,64233382,65509251,68033133,68298642,69994906,70559435,70775484,71738863,75373798,76109720,81188158,82711762,86297495,87090585,91211188,92220504,92227511,92990090,93671516,95855325,97069414,107950652,108309058,109018220,115208219,118821189,121839321,128790325,131468415,4175301,6889178,7352462,10128391,10367939,16597563,19963012,22181956,23270716,23374654,23575840,25082526,26029428,32892058,37349716,37352341,37706142,40334351,40952004,41363517,43950895,44113507,48068629,55363154,55434292,59541303,66907276,71861980,72886065,78483680,79191627,83850404,85248525,88549082,90072278,90742122,93004313,95009985,95860319,98208909,101117472,103201280,106396490,106899852,109382481,109930919,115734370,122595306,123907903,128955746,129505215,129594561,130978554,132566389,134621447,577373,2527142,2905507,3057743,6218402,9956555,12658442,15858888,20473893,25112196,33324243,34582769,43045286,44580524,48929063,57258242,57876898,58991661,59272180,61522754,62417392,68229338,70578987,71188700,77518530,81080019,85161744,92796724,93013927,103014644,108634831,112181539,114131023,118755942,122067498,125544762,127132206,128276666,130573772,132368583,133825824,21488828,22335544,24376837,26816264,27466389,34738966,36818914,46897499,47387940,48792420,50579077,50816917,51735280,53037516,53070237,55238031,57395823,60441949,63813301,64263819,65185508,68747085,68977877,85105644,87770448,93703457,95290106,102176440,103500932,105036282,105809814,106226828,107033444,110062912,114427817,114570901,19267738,23109560,24186788,24852539,26701607,27248698,28415866,33254201,41731050,46410679,46581156,49268587,50110406,55018464,56163503,56777186,59266338,63659020,71945405,72099237,74115168,78996172,87748356,88929909,98179974,102950245,33093626,37792931,39520102,40896391,41465046,42617434,43093359,43921219,49609604,54883626,58231560,60909751,62651508,66241592,79084263,80023059,80815199,85122060,85923278,86827402,87890976,93888761,97651433,102146712,102335374,2805750,4798965,12445471,16224980,18119425,19980124,20672211,23746848,23773742,24675483,26118440,26860769,29131636,32598581,34242034,34815444,49335847,58477355,61323353,62302215,62544334,63301261,67209888,72424810,72572514,77747001,81177516,81646383,82319921,82416538,735172,2667560,5587680,8117279,13404936,13684795,13799548,13907785,16643880,18815297,19810587,19941644,26014177,32655027,36370453,36425043,36564468,39237648,58576247,61951741,64758260,68327441,72882606,73245181,79398735,80349858,2930232,8927355,9848335,11427642,22147879,25871829,26822681,28477467,31547319,33304597,35134173,36654359,38001931,38259899,49177778,54021694,61381884,63117336,63711870,63829973,63840612,69130286,71114426,75230171,75398294,77857360,1838097,3334367,4294839,5723008,7568221,12486739,16087938,16598142,17141632,20095927,20893029,30850007,33650408,35247982,38803646,40976153,42008540,42235749,43614841,43914732,44377945,44936656,50509418,53688110,55379078,56359635,58203870,58901043,416583,9138764,9326268,9950593,13010428,13200672,15295625,18306417,29577658,31288859,33684695,33738420,35387990,35575615,35760013,36619715,42981017,43197724,45331199,49492659,51009184,51687530,57977286,64399756,66157594,69958951,75092065,82500018,106399859,107876846,109142078,117566775,120295135,121664281,125084981,126492082,130776292,132135680,134765891,136793791,142104875,144058559,147611519,151471011,151588795,152668671,153459801,155467043,156151388,159282425,160562439,162375857,175169143,175396175,176593166,184270204,187578729,192971491,194833626,197018239,208888030,213166437,214731322,214914070,223276392,223465169,227017557,231464217,232043284,236451182,242860574,242945463,3177122,6106074,8816504,11517265,12283936,14284633,14767973,16662596,18299515,25901200,32303439,34169372,34375782,35891595,40938745,43905837,44176926,48405202,60457179,10743283,15652867,18240956,23084711,23188291,28938926,29738561,32679907,38697425,39911588,41429498,42122568,42643165,42912650,17879447,20031029,21808907,24345244,25039839,34637302,35295144,36533738,39722262,42131041,43149375,46571423,49450272,50776029,284497,1416184,2615802,4142356,7399980,10236433,11812297,12900595,22298906,22657589,22784929,23665536,32829405,35319301,35400053,47525818,47984926,48819039,49783822,50342965,51146512,52709837,59873181,66729532,67811367,69379826,76441314,76951798,82823758,84699412,86435057,86567681,88565701,89284630,90464913,94039131,95683164,97703864,101541078,106087197,106595372,108478641,108553846,110792496,113385980,114113249,123414855,124356994,124917388,130511413,131628715,132805127,135988567,138272277,138290101,141818266,142543018,151395580,152115721,158865258,159398003,161814423,163070374,165040860,166473229,170656754,174909270,181081073,191856085,192116289,194393490,195198396,197816320,880996,5484344,8766889,9636226,10512672,12848570,16713366,17300628,18860102,19735120,20474089,24375274,28350050,29907839,32704657,32940519,33473013,36855856,41068089,43014021,43286125,47991694,57460382,58805604,58826272,62284131,63026827,63445684,63727723,63972145,70527302,74475580,77238123,77445963,84391001,85082626,88649450,91265825,92450933,94348341,99680781,102475400,102787786,106244080,111625895,112367003,119085155,122403785,125292126,125621328,129303526,131036765,131248973,134479920,135481999,137248434,140528323,142312333,142783531,144726990,150133237,152898618,160603180,162343931,164138639,167412029,172736320,173557112,175194482,179429105,180984842,184938864,189793239,3100083,6024723,6955830,10887238,14540779,17716741,19078543,21603394,21715128,23023374,25335775,28151983,32085289,33174260,40138175,43870854,44929217,49588034,50075826,57386349,68591802,71255716,76853469,79428483,80882496,81905606,85296199,86112992,95343311,97187510,104350505,107079984,109474762,114880849,115461026,116954899,121476790,123278817,124923448,130595122,134000605,135621853,136059727,136452741,136490066,138777624,139752772,140794615,141917539,144131408,148571155,148639999,153975724,155939937,158916098,160275689,162166934,163072542,163172098,164174239,169548664,171905085,174412917,174783097,177653367,180191079,381951,1127106,3018199,4021012,4733829,5555042,8958791,9460377,11858045,11867171,11922598,19126124,21716408,23685987,30221997,32657952,32773435,36119523,37850150,46130270,46366480,49158287,49225123,49339482,53630502,57982166,62307638,62558389,63527383,68073852,68502446,69500848,74527801,74904345,75296289,77344489,79176411,80524946,81644845,89955521,92900768,95359256,95464267,95548109,95929814,98132878,104004177,111335532,123515058,126160374,126978740,132016110,134028921,135935983,137777669,140019503,140954711,144196404,148254814,149286024,150375259,159110017,161147297,162616509,162737994,163328861,164034953,167188348,167905836,169656705,170824453,2759405,3464088,3549790,5862765,5901547,8872625,9437987,10370518,14415043,16699780,18040402,18273084,23881776,28682568,28950615,30074455,34952936,38263731,39546348,45484063,46278176,48581297,49173341,53358295,62015892,62116858,66825745,67340864,76804368,76870796,78662193,79868212,89583536,96853483,98677585,100610894,102497562,105389481,107722761,109256795,110819951,112334961,114956601,117914839,119179386,119920762,123194557,124814705,125833422,125837850,127429410,131373038,135916815,137293926,138477963,140472196,145249875,149487134,152064321,152760103,153975785,155862520,157145784,1378565,9555102,10142002,10194949,13170250,14038290,14054820,15945390,16962205,18790846,19980262,22335670,40364408,41222278,41224704,43185150,48290772,49904859,53361086,54896949,56055614,56202359,56777472,60744951,66344795,67485720,81172610,84035279,86514700,91144724,95765395,98595392,99490889,102615334,115825993,119931098,122368426,124225928,124680183,128109046,132942724,134524224,135491414,138146244,138857136,139401876,142851052,143273215,144217771,145115952,508544,580857,2745926,5641637,6620055,8019345,9275047,10958051,11085275,13729936,17244100,26459832,28173353,34184349,34358871,35245174,76705629,87136114,87277833,88785808,89425514,104823082,106225448,108081061,109013694,110046494,110556445,111905883,111912272,112520099,114340596,117700491,120139492,125379135,127141244,127885509,128035129,134448979,135296997,138194124,140429553,140747614,541025,793147,828838,2162032,5361806,6338280,15839688,17556037,23384572,25333375,25889622,31811560,36512038,43886095,48127600,65067869,67827481,88368129,97278651,98111872,104070748,109730872,113253298,115208182,122977609,126852159,129525281,131744890,132221059,137350678,138508519,140957172,149551136,150997048,153820981,154314369,154386087};
   //}}} 
    //{{{ ends
    //}}}    
    uint32_t j = 0;
    while (i->input_file_get_next_interval(i,
                                           &chrm,
                                           &chrm_len,
                                           &start,
                                           &end,
                                           &offset,
                                           &line) >= 0) {
        TEST_ASSERT_TRUE(strcmp(chrm,chrms[j]) == 0);
        TEST_ASSERT_EQUAL(starts[j], start);
        j+=1;
    }

    input_file_destroy(&i);
    if (line.s != NULL)
        free(line.s);
}
//}}}
